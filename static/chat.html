<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA // Radio Show</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(2vw, -5vh) rotate(2deg); }
            66% { transform: translate(-1vw, 3vh) rotate(-1deg); }
        }
        
        .animate-aura {
            animation: float 18s infinite ease-in-out;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-hover:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .mood-badge {
            transition: all 0.3s ease;
        }

        .mood-badge.active {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }
    </style>
</head>
<body class="bg-[#020202] text-white overflow-hidden" 
      x-data="chatApp()" 
      x-init="init()">

    <div class="fixed inset-0 z-0">
        <div class="absolute top-[-20%] left-[-10%] w-[70vw] h-[70vw] bg-purple-600/20 rounded-full blur-[120px] animate-aura"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[60vw] h-[60vw] bg-blue-600/15 rounded-full blur-[120px] animate-aura" style="animation-delay: -9s;"></div>
    </div>

    <div class="relative z-10 h-screen flex flex-col">
        
        <nav class="flex justify-between items-center p-6 border-b border-white/10">
            <div class="flex items-center space-x-4">
                <a href="/" class="text-2xl font-black tracking-tighter italic hover:opacity-80 transition-opacity">AURA.</a>
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <span class="text-xs text-gray-500 font-medium">LIVE</span>
                    <span class="text-xs text-gray-500">Radio Show</span>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <div class="glass px-3 py-1.5 rounded-full text-xs" x-show="currentMood">
                    <span class="text-gray-400">Mood: </span>
                    <span class="font-bold capitalize" x-text="currentMood"></span>
                </div>
                <a href="/" class="glass px-4 py-2 rounded-full text-xs hover:bg-white/10 transition-all">
                    Home
                </a>
            </div>
        </nav>

        <main class="flex-1 flex flex-col overflow-hidden">
            
            <!-- Chat Messages Area -->
            <div class="flex-1 overflow-y-auto px-6 py-6 space-y-4" 
                 x-ref="chatContainer"
                 style="scroll-behavior: smooth;">
                
                <!-- Welcome Message -->
                <div class="flex items-start space-x-3 fade-in" x-show="messages.length === 0">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-rose-500 flex items-center justify-center flex-shrink-0">
                        <span class="text-lg">üéôÔ∏è</span>
                    </div>
                    <div class="glass rounded-2xl rounded-tl-sm p-4 max-w-md">
                        <p class="text-sm leading-relaxed">
                            <span class="font-bold text-indigo-400">üéµ Welcome to AURA Radio! üéµ</span><br><br>
                            Hey there! I'm your Radio Jockey, and I'm here to chat and play the perfect music for you! 
                            Tell me about your day, how you're feeling, what you're up to, or what kind of music you're in the mood for, 
                            and I'll spin some tracks just for you! Let's make this a great show! üéß‚ú®
                        </p>
                    </div>
                </div>

                <!-- Chat Messages -->
                <template x-for="(msg, index) in messages" :key="index">
                    <div class="flex items-start space-x-3 fade-in" 
                         :class="msg.type === 'user' ? 'flex-row-reverse space-x-reverse' : ''">
                        
                        <!-- Avatar -->
                        <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0"
                             :class="msg.type === 'user' ? 'bg-indigo-500/20' : 'bg-gradient-to-br from-indigo-500 to-rose-500'">
                            <span class="text-lg" x-text="msg.type === 'user' ? 'üë§' : 'üéôÔ∏è'"></span>
                        </div>
                        
                        <!-- Message Bubble -->
                        <div class="glass rounded-2xl p-4 max-w-md"
                             :class="msg.type === 'user' ? 'rounded-tr-sm bg-indigo-500/10' : 'rounded-tl-sm'">
                            <p class="text-sm leading-relaxed" x-text="msg.text"></p>
                            
                            <!-- Mood Badge (for bot messages) -->
                            <div class="mt-2 flex items-center space-x-2" x-show="msg.mood">
                                <span class="text-xs text-gray-400">Detected mood:</span>
                                <span class="text-xs px-2 py-1 rounded-full glass capitalize" 
                                      x-text="msg.mood"></span>
                            </div>
                            
                            <!-- Song Recommendations (for bot messages) -->
                            <div class="mt-3" x-show="msg.songs && msg.songs.length > 0">
                                <p class="text-xs text-indigo-400 font-medium mb-2 flex items-center">
                                    <span class="mr-1">üéµ</span>
                                    <span>Now Playing on AURA Radio:</span>
                                </p>
                                <div class="space-y-2">
                                    <template x-for="(song, idx) in msg.songs" :key="idx">
                                        <button @click="playSong(song)"
                                                class="w-full glass rounded-lg p-3 text-left hover:bg-indigo-500/10 transition-all flex items-center space-x-3 group border border-white/5 hover:border-indigo-500/30">
                                            <div class="relative">
                                                <img :src="song.image || 'https://via.placeholder.com/48?text=üéµ'" 
                                                     :alt="song.title"
                                                     class="w-12 h-12 rounded object-cover">
                                                <div class="absolute inset-0 bg-indigo-500/20 rounded opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M8 5v14l11-7z"/>
                                                    </svg>
                                                </div>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium truncate text-white" x-text="song.title"></p>
                                                <p class="text-xs text-gray-400 truncate" x-text="song.artists?.join(', ') || 'Unknown Artist'"></p>
                                                <p class="text-xs text-indigo-400/70 mt-0.5" x-show="song.genre && song.genre.length > 0" 
                                                   x-text="song.genre?.slice(0, 2).join(', ')"></p>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-xs text-indigo-400/50 group-hover:text-indigo-400 transition-colors">Play</span>
                                                <svg class="w-5 h-5 text-gray-400 group-hover:text-indigo-400 transition-colors" 
                                                     fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M8 5v14l11-7z"/>
                                                </svg>
                                            </div>
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Typing Indicator -->
                <div class="flex items-start space-x-3 fade-in" x-show="typing">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-rose-500 flex items-center justify-center flex-shrink-0">
                        <span class="text-lg">üéôÔ∏è</span>
                    </div>
                    <div class="glass rounded-2xl rounded-tl-sm p-4">
                        <div class="typing-indicator text-gray-400">
                            <span class="text-xs mr-2">RJ is thinking...</span>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Mood Display -->
            <div class="px-6 py-4 border-t border-white/10" x-show="currentMood">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-xs text-gray-400">Current Mood:</span>
                        <span class="px-3 py-1.5 rounded-full glass capitalize font-medium mood-badge"
                              :class="getMoodColor(currentMood)"
                              x-text="currentMood"></span>
                    </div>
                    <button @click="getMoodRecommendations()" 
                            class="glass px-4 py-2 rounded-full text-xs hover:bg-indigo-500/20 transition-all flex items-center space-x-2">
                        <span>üéµ</span>
                        <span>Request Songs</span>
                    </button>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-6 border-t border-white/10">
                <form @submit.prevent="sendMessage()" class="flex items-end space-x-3">
                    <div class="flex-1 glass rounded-2xl p-4 focus-within:ring-2 focus-within:ring-indigo-500/50 transition-all">
                        <textarea x-model="inputMessage"
                                  @keydown.enter.exact.prevent="sendMessage()"
                                  @keydown.enter.shift.exact="inputMessage += '\n'"
                                  placeholder="Call in to the show! Tell me about your day, how you're feeling, or what music you want to hear..."
                                  rows="2"
                                  class="w-full bg-transparent border-none outline-none resize-none text-sm"
                                  style="min-height: 2.5rem; max-height: 8rem;"></textarea>
                    </div>
                    <button type="submit"
                            :disabled="!inputMessage.trim() || sending"
                            class="glass p-4 rounded-2xl hover:bg-indigo-500/20 transition-all disabled:opacity-50 disabled:cursor-not-allowed active:scale-95">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </form>
                
                <!-- Quick Mood Buttons -->
                <div class="mt-4 flex flex-wrap gap-2">
                    <template x-for="mood in quickMoods" :key="mood">
                        <button @click="sendQuickMessage(mood)"
                                class="glass px-4 py-2 rounded-full text-xs hover:bg-white/10 transition-all active:scale-95"
                                :class="currentMood === mood ? 'ring-2 ring-indigo-500' : ''">
                            <span x-text="mood"></span>
                        </button>
                    </template>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8000/api/v1'
            : window.location.origin + '/api/v1';
        
        function chatApp() {
            return {
                messages: [],
                inputMessage: '',
                typing: false,
                sending: false,
                currentMood: null,
                quickMoods: ['happy', 'sad', 'calm', 'energetic', 'tired', 'anxious', 'romantic', 'focused'],
                userId: localStorage.getItem('aura_user_id') || 'user_' + Math.random().toString(36).substr(2, 9),

                init() {
                    localStorage.setItem('aura_user_id', this.userId);
                },

                async sendMessage() {
                    if (!this.inputMessage.trim() || this.sending) return;
                    
                    const userMessage = this.inputMessage.trim();
                    this.inputMessage = '';
                    
                    // Add user message
                    this.messages.push({
                        type: 'user',
                        text: userMessage,
                        timestamp: new Date().toISOString()
                    });
                    
                    this.scrollToBottom();
                    this.typing = true;
                    this.sending = true;
                    
                    try {
                        // Send to chatbot API
                        const response = await fetch(`${API_BASE}/chat/message`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                user_id: this.userId,
                                message: userMessage
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            // Update current mood
                            this.currentMood = data.detected_mood;
                            
                            // Add bot response
                            this.messages.push({
                                type: 'bot',
                                text: data.response,
                                mood: data.detected_mood,
                                confidence: data.confidence,
                                songs: data.recommended_songs || []
                            });
                            
                            // Auto-play first song if available
                            if (data.recommended_songs && data.recommended_songs.length > 0) {
                                setTimeout(() => {
                                    this.playSong(data.recommended_songs[0]);
                                }, 1000);
                            }
                        }
                    } catch (error) {
                        console.error('Chat error:', error);
                        this.messages.push({
                            type: 'bot',
                            text: "Sorry, I'm having trouble right now. Please try again!",
                            mood: null
                        });
                    } finally {
                        this.typing = false;
                        this.sending = false;
                        this.scrollToBottom();
                    }
                },

                sendQuickMessage(mood) {
                    const messages = {
                        'happy': "I'm feeling great today!",
                        'sad': "I'm feeling a bit down.",
                        'calm': "I'm feeling peaceful and relaxed.",
                        'energetic': "I'm full of energy!",
                        'tired': "I'm feeling tired and drained.",
                        'anxious': "I'm feeling anxious and stressed.",
                        'romantic': "I'm in a romantic mood.",
                        'focused': "I need to focus and concentrate."
                    };
                    
                    this.inputMessage = messages[mood] || `I'm feeling ${mood}.`;
                    this.sendMessage();
                },

                async getMoodRecommendations() {
                    if (!this.currentMood) return;
                    
                    this.typing = true;
                    try {
                        const response = await fetch(`${API_BASE}/chat/mood-recommendations?user_id=${this.userId}&mood=${this.currentMood}&limit=5`);
                        const data = await response.json();
                        
                        // Show personalized indicator if taste profile is used
                        if (data.personalized) {
                            console.log('‚úì Recommendations personalized with your taste profile');
                        }
                        
                        if (response.ok && data.songs) {
                            this.messages.push({
                                type: 'bot',
                                text: `Perfect! Let me play some ${this.currentMood} tracks for you! Here's what I've got lined up! üéµ`,
                                mood: this.currentMood,
                                songs: data.songs
                            });
                            
                            if (data.songs.length > 0) {
                                setTimeout(() => {
                                    this.playSong(data.songs[0]);
                                }, 500);
                            }
                        }
                    } catch (error) {
                        console.error('Error getting recommendations:', error);
                    } finally {
                        this.typing = false;
                        this.scrollToBottom();
                    }
                },

                playSong(song) {
                    // Track listening
                    fetch(`${API_BASE}/listening/track`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: this.userId,
                            song_title: song.title || song.song?.title,
                            artists: song.artists || song.song?.artists || [],
                            source: 'chatbot',
                            platform: 'youtube',
                            metadata: { mood: this.currentMood }
                        })
                    }).catch(err => console.error('Error tracking:', err));
                    
                    // Navigate to play page
                    const songData = {
                        title: song.title || song.song?.title,
                        artists: song.artists || song.song?.artists || [],
                        image: song.image || song.song?.image,
                        youtube_video_id: song.youtube_video_id || song.song?.youtube_video_id
                    };
                    
                    window.location.href = `/play?song=${encodeURIComponent(JSON.stringify(songData))}`;
                },

                scrollToBottom() {
                    this.$nextTick(() => {
                        const container = this.$refs.chatContainer;
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });
                },

                getMoodColor(mood) {
                    const colors = {
                        'happy': 'bg-yellow-500/20 text-yellow-400',
                        'sad': 'bg-blue-500/20 text-blue-400',
                        'calm': 'bg-green-500/20 text-green-400',
                        'energetic': 'bg-red-500/20 text-red-400',
                        'tired': 'bg-gray-500/20 text-gray-400',
                        'anxious': 'bg-orange-500/20 text-orange-400',
                        'romantic': 'bg-pink-500/20 text-pink-400',
                        'focused': 'bg-purple-500/20 text-purple-400'
                    };
                    return colors[mood] || 'bg-indigo-500/20 text-indigo-400';
                }
            }
        }
    </script>
</body>
</html>

